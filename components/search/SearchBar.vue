<template>
  <div class="search-bar-container">
    <b-autocomplete
      ref="searchRef"
      v-model="name"
      class="gallery-search"
      :placeholder="$t('general.searchPlaceholder')"
      icon="search"
      :open-on-focus="showDefaultSuggestions"
      clearable
      max-height="500"
      dropdown-position="bottom"
      expanded
      @blur="$emit('blur')"
      @keydown.native.enter="onEnter">
      <template #header>
        <SearchSuggestion
          :name="name"
          :show-default-suggestions="showDefaultSuggestions"
          :query="query"
          @gotoGallery="redirectToGalleryPageIfNeed"
          @close="closeDropDown">
        </SearchSuggestion>
      </template>
    </b-autocomplete>
    <div class="search-bar-bg"></div>
    <img
      v-if="!name"
      class="search-bar-keyboard-icon"
      src="/search-k-keyboard.svg" />
  </div>
</template>

<script lang="ts">
import {
  Component,
  Emit,
  Prop,
  Ref,
  VModel,
  mixins,
} from 'nuxt-property-decorator'
import { SearchQuery } from './types'
import PrefixMixin from '~/utils/mixins/prefixMixin'
import KeyboardEventsMixin from '~/utils/mixins/keyboardEventsMixin'

const SearchPageRoutePathList = ['/collections', '/gallery', '/explore']

@Component({
  components: {
    SearchSuggestion: () => import('./SearchSuggestion.vue'),
  },
})
export default class extends mixins(PrefixMixin, KeyboardEventsMixin) {
  @Prop({ type: Object, required: false }) public query!: SearchQuery
  @VModel({ type: String }) name!: string
  @Ref('searchRef') readonly searchRef

  public created() {
    this.initKeyboardEventHandler({
      k: this.bindSearchEvents,
    })
  }

  @Emit('enter')
  onEnter() {
    this.redirectToGalleryPageIfNeed()
    this.closeDropDown()
  }

  public focusInput(): void {
    this.searchRef?.focus()
  }

  private bindSearchEvents(event) {
    event.preventDefault()
    if (event.key === 'k') {
      this.focusInput()
    }
  }

  public closeDropDown() {
    this.searchRef.isActive = false
  }

  get showDefaultSuggestions() {
    return this.urlPrefix === 'rmrk'
  }

  redirectToGalleryPageIfNeed(params?: Record<string, string>) {
    if (SearchPageRoutePathList.indexOf(this.$route.path) === -1) {
      this.$router.replace({
        name: `${this.urlPrefix}-explore`,
        query: {
          ...this.$route.query,
          ...params,
        },
      })
    }
  }
}
</script>

<style lang="scss">
@import '@/styles/abstracts/variables';
.search-bar-container {
  position: relative;
  .search-bar-bg {
    position: absolute;
    width: 100%;
    height: 100%;
    background: #fff;
    top: 4px;
    left: 4px;
    z-index: 0;
  }
  .search-bar-keyboard-icon {
    z-index: 2;
    position: absolute;
    right: 18px;
    top: 9px;
    pointer-events: none;
  }
}
.gallery-search {
  z-index: 1;
  .control .icon {
    color: $white;
  }

  input {
    border: 1px solid $white;
    background-color: $dark;
    border-radius: 0;
    padding: 0 50px !important;
    background-color: $search-background-color;

    &::placeholder {
      color: $placeholder-color !important;
      margin-left: 10px;
      font-weight: 400;
    }
    &:hover {
      border: 1px solid $white;
    }
    &:focus {
      border: 1px solid $white;
    }
  }
}
</style>
