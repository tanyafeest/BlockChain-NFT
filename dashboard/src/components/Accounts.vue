<template>
  <div class="Accounts">
    <b-button type="is-primary" @click="loadKeyring()">
      <font-awesome-icon icon="play"/>
      Load Testing Accounts</b-button>
      <b-switch v-model="hideTestingAccounts"
        :outlined="switchStyle.isOutlined"
        :rounded="switchStyle.isRounded"
        :size="switchStyle.size"> Hide Testing Acc
      </b-switch>
    <b-select v-model="theme">
      <option selected>polkadot</option>
      <option>substrate</option>
      <option>beachball</option>
    </b-select>
    <div>
      <font-awesome-icon icon="key"/> Password 
      <b-input type="passowrd" v-model="password" 
        password-reveal></b-input>
    </div>
    <div> 
      <Restore 
        :password="password" />
    </div>
    <b-button type="is-light" @click="mapAccounts()">
      <font-awesome-icon icon="redo"/>
      Refresh Accounts</b-button>
    <ul>
      <li 
        v-for="acc in keyringAccounts"
        v-bind:key="acc.address"
      > 
        <AccountKeypair v-if="hideTestingAccounts == !acc.meta.isTesting"
          :address="acc.address"
          :theme="theme"
          :meta="acc.meta"
          :publicKey="vueU8aToHex(acc.publicKey)"
          :type="acc.type"
        />
        <b-button v-if="hideTestingAccounts == !acc.meta.isTesting"
          type="is-warning" @click="forgetAccount(acc.address)">
          <font-awesome-icon icon="trash"/>  
          Forget Account</b-button>
        <Backup v-if="!acc.meta.isTesting"
          :address="acc.address"
          :password="password" />
      </li>
    </ul>
  </div>
</template>

<script lang="ts">
import { Component, Prop, Vue } from 'vue-property-decorator';
import keyring from '@vue-polkadot/vue-keyring';
import AccountKeypair from './accounts/AccountKeypair.vue';
import Backup from './accounts/Backup.vue';
import Restore from './accounts/Restore.vue';
import { waitReady } from '@polkadot/wasm-crypto';
import { u8aToHex } from '@polkadot/util';

@Component({
  components: {
    AccountKeypair,
    Backup,
    Restore,
  },
})
export default class Accounts extends Vue {
  public keys: any = '';
  public theme: string = 'polkadot';
  public password: string = 'password';
  public switchStyle: object = { isOutlined: true, isRounded: true, size: 'is-medium' };
  public hideTestingAccounts: boolean = false;
  public keyringAccounts: any = [
    { address: '', meta: { name: ''}, publicKey: '', type: '' },
  ];

  public vueU8aToHex(publicKey: Uint8Array): string {
    return u8aToHex(publicKey);
  }

  public forgetAccount(address: string): void {
    keyring.forgetAccount(address);
    this.mapAccounts();
  }

  public loadKeyring(): void {
    keyring.loadAll({
      ss58Format: 42, type: 'sr25519',
      isDevelopment: true });

    this.keys = keyring;
    this.mapAccounts();
  }

  public mapAccounts(): void {
    this.keyringAccounts = keyring.getPairs();
  }

  public async mountWasmCrypto(): Promise<void> {
    await waitReady();
    console.log('loaded');
    // console.log(keyring.encodeAddress('0x6674a2958bf589aca9056d57b26f758c50d5aa95aa36dcfbb8659a8bdf7eef6d'));
  }

  public mounted(): void {
    this.mountWasmCrypto();
  }
}
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped>
</style>
